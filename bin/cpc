#!/bin/zsh

# ////////////////////////////////////////////////////////////////
# Globals
# ////////////////////////////////////////////////////////////////

g_script_dir="$(dirname "$0")"
g_src_dir="$(pwd)/src"

g_languages=("cpp")

fzf="$g_script_dir/fzf"

# ////////////////////////////////////////////////////////////////
# Utils
# ////////////////////////////////////////////////////////////////

function lower() { cat - | tr '[:upper:]' '[:lower:]'; }

function regex_match() {
  local pattern="$1" string="$2"
  expr "$string" : "$pattern" >/dev/null
}

function regex_replace() {
  local pattern="$1" replacement="$2" string="$3"
  echo "$string" | sed "s/$pattern/$replacement/"
}

function validate_language() {
  local language="$1"
  [ -n "$language" ] && printf "%s\n" "${g_languages[@]}" | grep -q -E "^$language$"
}

function select_language() {
  printf "%s\n" "${g_languages[@]}" | $fzf
}

# ////////////////////////////////////////////////////////////////
# AtCoder
# ////////////////////////////////////////////////////////////////

function atcoder_get_root_dir() {
  echo "$g_src_dir/atcoder"
}

function atcoder_get_template() {
  local language="$1"
  ! validate_language "$language" && echo "unsupported language: $language" && exit 1
  echo "$(atcoder_get_root_dir)/template.$language"
}

function atcoder_url_pattern() {
  echo '^https:\/\/atcoder.jp\/contests\/\([a-zA-Z0-9_-]*\)\/tasks\/\([a-zA-Z0-9_-]*\)$'
}

function atcoder_url_match() {
  local url="$1"
  regex_match "$(atcoder_url_pattern)" "$url"
}

function atcoder_url_get_contest_id() {
  local url="$1"
  regex_replace "$(atcoder_url_pattern)" "\1" "$url" | lower
}

function atcoder_url_get_task_id() {
  local url="$1"
  regex_replace "$(atcoder_url_pattern)" "\2" "$url" | lower
}

function atcoder_url_get_task_dir() {
  local url="$1"
  local contest_id task_id
  contest_id="$(atcoder_url_get_contest_id "$url")"
  task_id="$(atcoder_url_get_task_id "$url")"
  echo "$(atcoder_get_root_dir)/$contest_id/$task_id"
}

function atcoder_task_get_testcase_dir() {
  local task_dir="$1"
  echo "$task_dir/test"
}

function atcoder_task_create_new_answer() {
  local task_dir="$1" language="$2"
  local index
  index="$(find "$task_dir" -maxdepth 1 -type f -name "*.$language" | wc -l | awk '{ print $1 }')"
  echo "$task_dir/main_$index.$language"
}

function atcoder_task_select_answer() {
  local task_dir="$1"
  find "$task_dir" -maxdepth 1 -type f | $fzf
}

# ////////////////////////////////////////////////////////////////
# Runner
# ////////////////////////////////////////////////////////////////

function run_cpp() {
  local src="$1" in="$2" out="$3"
  local dest="${src%.*}"

  [[ ! "$src" =~ ^/.* ]] && echo "src must be abstract path: $src" && exit 1

  function build() {
    local cxx cxxflags
    cxx="/usr/local/bin/g++-9"
    cxxflags=($(cat "$g_script_dir/../compile_flags.txt"))

    $cxx "$src" -o "$dest" "${cxxflags[*]}"
  }

  function run() {
    $dest <"$in" >"$out"
  }

  function clean() {
    rm -f "$dest"
  }

  build && trap clean EXIT && run
}

build() {
  local cxx cxxflags src target

  cxx="/usr/local/bin/g++-9"
  cxxflags=($(cat "$g_script_dir/../compile_flags.txt"))
  src="$(realpath "$1")"
  target="${src%.*}"

  $cxx ${cxxflags[*]} "$src" -o "$target"

  echo "$target"
}

run_tests() {
  local red='\033[0;31m' green='\033[0;32m' nocolor='\033[0m'
  local target="$1" testcase_dir="$2"

  cols() { tput cols; }

  str_repeat() { seq -f "$1" -s "" "$2"; }

  bar() { echo "$(str_repeat "$1" "$(cols)")"; }

  assert() {
    local target="$1" in="$2" out="$3"
    local actual result_diff result_status message

    actual="$(mktemp)"
    trap "rm -f $actual" EXIT
    $target <"$in" >"$actual"

    result_diff="$(sdiff "$out" "$actual" -w "$(cols)")"
    result_status=$?
    if [ $result_status -eq 0 ]; then
      message="${green}OK${nocolor}"
    else
      message="${red}NG${nocolor}"
    fi

    bar "-"
    echo Input:
    echo "$(cat $in)"
    echo
    echo Output:
    echo $result_diff
    echo
    echo Status:
    echo $message
    bar "-"

    return $result_status
  }

  in_file() { echo "$testcase_dir/sample-$1.in"; }

  out_file() { echo "$testcase_dir/sample-$1.out"; }

  local i=1 result_status n_ok=0 n_ng=0
  while [ -f "$(in_file $i)" ] && [ -f "$(out_file $i)" ]; do
    assert "$target" "$(in_file $i)" "$(out_file $i)"
    if [ $? -eq 0 ]; then
      n_ok=$((n_ok + 1))
    else
      n_ng=$((n_ng + 1))
    fi
    i=$((i + 1))
  done

  bar "="
  [ $n_ok -gt 0 ] && echo "${green}${n_ok}${nocolor} passed."
  [ $n_ng -gt 0 ] && echo "${red}${n_ng}${nocolor} failed."
  bar "="
}

# ////////////////////////////////////////////////////////////////
# Commands
# ////////////////////////////////////////////////////////////////

new_command() {
  new_atcoder() {
    local url="$1" language="$2"

    if ! validate_language "$language"; then
      language="$(select_language)"
    fi

    local task_dir template new_answer testcase_dir

    task_dir="$(atcoder_url_get_task_dir "$url")"
    template="$(atcoder_get_template "$language")"
    new_answer="$(atcoder_task_create_new_answer "$task_dir" "$language")"
    testcase_dir="$(atcoder_task_get_testcase_dir "$task_dir")"

    mkdir -p "$task_dir" &&
      cp "$template" "$new_answer" &&
      oj d "$url" -d "$testcase_dir"
  }

  [ $# -lt 1 ] && echo "too few arguments" && exit 1

  if atcoder_url_match "$1"; then
    new_atcoder "$1" "$2"
  else
    echo "unsupported format: $1" && exit 1
  fi
}

test_command() {
  test_atcoder() {
    local url="$1"
    local task_dir answer testcase_dir target
    task_dir="$(atcoder_url_get_task_dir "$url")"
    answer="$(atcoder_task_select_answer "$task_dir")"
    testcase_dir="$(atcoder_task_get_testcase_dir "$task_dir")"

    target="$(build "$answer")"
    trap "rm -f $target" EXIT

    run_tests "$target" "$testcase_dir"
  }

  test_local() {
    local task_dir="$1"
    local answer testcase_dir target
    task_dir="$(realpath "$task_dir")"
    answer="$(atcoder_task_select_answer "$task_dir")"
    testcase_dir="$(atcoder_task_get_testcase_dir "$task_dir")"

    target="$(build "$answer")"
    trap "rm -f $target" EXIT

    run_tests "$target" "$testcase_dir"
  }

  [ $# -lt 1 ] && echo "too few arguments" && exit 1

  if atcoder_url_match "$1"; then
    test_atcoder "$1"
  elif [ -f "$1" ]; then
    test_local "$1"
  else
    echo "unsupported format: $1" && exit 1
  fi
}

submit_command() {
  submit_atcoder() {
    local url="$1"
    local task_dir answer
    task_dir="$(atcoder_url_get_task_dir "$url")"
    answer="$(atcoder_task_select_answer "$task_dir")"

    oj s "$url" "$answer" -y
  }

  [ $# -lt 1 ] && echo "too few arguments" && exit 1

  if atcoder_url_match "$1"; then
    submit_atcoder "$1"
  else
    echo "unsupported format: $1" && exit 1
  fi
}

# ////////////////////////////////////////////////////////////////
# Main
# ////////////////////////////////////////////////////////////////

case "$1" in
n | new) shift && new_command "$@" && exit 0 ;;
t | test) shift && test_command "$@" && exit 0 ;;
s | submit) shift && submit_command "$@" && exit 0 ;;
*) echo "unknown command: $1" && exit 1 ;;
esac
